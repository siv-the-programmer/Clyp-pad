<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipspace</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%230c0c0f'/><rect x='5' y='5' width='22' height='22' rx='5' fill='none' stroke='%234f8fff' stroke-width='2'/><circle cx='16' cy='16' r='4' fill='%234f8fff'/><line x1='16' y1='5' x2='16' y2='9' stroke='%234f8fff' stroke-width='2' stroke-linecap='round'/><line x1='16' y1='23' x2='16' y2='27' stroke='%234f8fff' stroke-width='2' stroke-linecap='round'/><line x1='5' y1='16' x2='9' y2='16' stroke='%234f8fff' stroke-width='2' stroke-linecap='round'/><line x1='23' y1='16' x2='27' y2='16' stroke='%234f8fff' stroke-width='2' stroke-linecap='round'/></svg>">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0c0c0f;--c1:#141418;--c2:#1c1c22;--c3:#242430;--c4:#2e2e3a;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --text:#e8e8ee;--sub:#6e6e82;--dim:#3a3a48;
  --blue:#4f8fff;--blue-a:rgba(79,143,255,0.13);
  --green:#32d17a;--red:#f05555;--amber:#f5a623;
  --purple:#9b6fff;--pink:#ff6eb4;--yellow:#ffd060;
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  --mono:ui-monospace,'SF Mono',monospace;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased;touch-action:none;user-select:none;}

/* ‚îÄ‚îÄ STAGE ‚îÄ‚îÄ */
#stage{position:fixed;inset:0;overflow:hidden;}
#grid-cvs{position:absolute;inset:0;pointer-events:none;}
#world{position:absolute;top:0;left:0;transform-origin:0 0;will-change:transform;backface-visibility:hidden;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar{position:fixed;top:0;left:0;right:0;height:48px;display:flex;align-items:center;gap:8px;padding:0 14px;background:rgba(12,12,15,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);z-index:100;}
.logo{font-size:15px;font-weight:800;letter-spacing:-.5px;flex-shrink:0;}
.logo em{color:var(--blue);font-style:normal;}
#back-btn{display:none;align-items:center;gap:5px;padding:0 10px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--c2);color:var(--sub);font:500 12px var(--font);cursor:pointer;transition:all .12s;flex-shrink:0;}
#back-btn:hover{background:var(--c3);color:var(--text);}
#bc{display:flex;align-items:center;gap:4px;flex:1;min-width:0;overflow:hidden;}
.bc-node{font-size:12px;color:var(--sub);cursor:pointer;white-space:nowrap;transition:color .12s;max-width:140px;overflow:hidden;text-overflow:ellipsis;}
.bc-node:hover{color:var(--text);}
.bc-node.cur{color:var(--text);font-weight:600;cursor:default;}
.bc-sep{color:var(--dim);font-size:11px;flex-shrink:0;}
.top-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
#zoom-lbl{font-size:11px;font-family:var(--mono);color:var(--sub);padding:3px 9px;background:var(--c2);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:color .12s;}
#zoom-lbl:hover{color:var(--text);}
.top-btn{padding:0 10px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--c2);color:var(--sub);font:500 11.5px var(--font);cursor:pointer;transition:all .12s;white-space:nowrap;}
.top-btn:hover{background:var(--c3);color:var(--text);}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
#toolbar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:3px;padding:6px 7px;background:rgba(12,12,15,0.95);backdrop-filter:blur(22px);border:1px solid var(--border2);border-radius:15px;box-shadow:0 8px 40px rgba(0,0,0,.65);z-index:100;white-space:nowrap;}
.tb{display:inline-flex;align-items:center;gap:5px;padding:0 10px;height:32px;border-radius:9px;font:500 12px var(--font);cursor:pointer;border:1px solid transparent;background:transparent;color:var(--sub);transition:all .12s;}
.tb:hover{background:var(--c2);color:var(--text);}
.tb:active{transform:scale(.95);}
.tb.accent{background:var(--blue);color:#fff;border-color:var(--blue);}
.tb.accent:hover{background:#3a7bf0;}
.tb.active{color:var(--blue);}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 1px;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{position:absolute;border-radius:11px;background:var(--c1);border:1.5px solid var(--border);cursor:grab;transform:translateZ(0);backface-visibility:hidden;transition:border-color .14s,box-shadow .14s;}
.card:hover{border-color:var(--border2);box-shadow:0 6px 28px rgba(0,0,0,.45);}
.card.sel{border-color:var(--blue)!important;box-shadow:0 0 0 2.5px rgba(79,143,255,.22),0 6px 28px rgba(0,0,0,.5)!important;}
.card.dragging{cursor:grabbing;box-shadow:0 20px 56px rgba(0,0,0,.7)!important;z-index:500;}

/* note */
.cn{min-width:180px;min-height:80px;display:flex;flex-direction:column;overflow:hidden;}
.cn-head{padding:11px 13px 5px;flex-shrink:0;}
.cn-title{font-size:12.5px;font-weight:700;color:var(--text);line-height:1.3;word-break:break-word;}
.cn-body{font-size:11.5px;color:var(--sub);line-height:1.55;word-break:break-word;overflow:hidden;flex:1;padding:0 13px 10px;}
.cn-foot{font-size:9.5px;color:var(--dim);padding:5px 13px;border-top:1px solid var(--border);flex-shrink:0;}

/* folder */
.cf{min-width:150px;padding:14px;display:flex;flex-direction:column;gap:9px;background:linear-gradient(135deg,#15151c,#111118);border-color:rgba(79,143,255,.18);}
.cf-ico{width:38px;height:38px;border-radius:9px;background:rgba(79,143,255,.1);border:1px solid rgba(79,143,255,.2);display:grid;place-items:center;font-size:18px;}
.cf-name{font-size:12.5px;font-weight:700;color:var(--text);word-break:break-word;}
.cf-meta{font-size:10px;color:var(--sub);}
.cf-hint{font-size:9.5px;color:var(--blue);opacity:0;transition:opacity .15s;font-weight:600;}
.cf:hover .cf-hint{opacity:1;}

/* label ‚Äî KEY FIX: transform-origin left top, no width constraint */
.cl{background:transparent;border-color:transparent;cursor:grab;padding:6px 10px;width:max-content;max-width:none;}
.cl:hover{border-color:var(--border);background:rgba(255,255,255,.02);}
.cl-text{font-weight:700;line-height:1.25;white-space:nowrap;display:block;transform-origin:left top;}

/* sticky */
.cs{min-width:160px;min-height:90px;display:flex;flex-direction:column;overflow:hidden;}
.cs-inner{flex:1;padding:12px;font-size:12px;line-height:1.6;color:#1a1a1a;word-break:break-word;overflow:hidden;}
.cs-foot{font-size:9px;padding:4px 10px;opacity:.5;flex-shrink:0;color:#1a1a1a;}

/* checklist */
.cch{min-width:200px;padding:12px;display:flex;flex-direction:column;gap:6px;overflow:hidden;}
.cch-title{font-size:12.5px;font-weight:700;color:var(--text);margin-bottom:4px;}
.cch-item{display:flex;align-items:flex-start;gap:7px;font-size:12px;color:var(--sub);line-height:1.4;}
.cch-box{width:14px;height:14px;border-radius:4px;border:1.5px solid var(--border2);flex-shrink:0;margin-top:1px;cursor:pointer;display:grid;place-items:center;transition:all .12s;}
.cch-box.done{background:var(--green);border-color:var(--green);}
.cch-box.done::after{content:'‚úì';font-size:9px;color:#fff;}
.cch-item.done-item .cch-label{text-decoration:line-through;opacity:.4;}

/* link */
.clk{min-width:200px;padding:12px 13px;display:flex;flex-direction:column;gap:5px;}
.clk-title{font-size:12.5px;font-weight:600;color:var(--text);}
.clk-url{font-size:10.5px;color:var(--blue);word-break:break-all;cursor:pointer;text-decoration:underline;}
.clk-desc{font-size:11px;color:var(--sub);line-height:1.5;}

/* shape card */
.cshp{background:transparent;border-color:transparent;padding:0;overflow:visible;}
.cshp:hover{border-color:var(--border);}
.cshp svg{display:block;overflow:visible;}

/* resize handle */
.rh{position:absolute;right:-1px;bottom:-1px;width:16px;height:16px;cursor:se-resize;display:none;align-items:flex-end;justify-content:flex-end;padding:3px;z-index:2;}
.card:hover .rh,.card.sel .rh{display:flex;}
.rh svg{opacity:.35;transition:opacity .12s;}
.rh:hover svg{opacity:.8;}

/* ‚îÄ‚îÄ TEMPLATES PANEL ‚îÄ‚îÄ */
#tpl-panel{position:fixed;left:0;top:48px;bottom:0;width:228px;background:rgba(12,12,15,0.97);backdrop-filter:blur(20px);border-right:1px solid var(--border);z-index:90;transform:translateX(-100%);transition:transform .25s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden;}
#tpl-panel.open{transform:translateX(0);}
.tpl-hd{padding:12px 14px 8px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;flex-shrink:0;}
.tpl-list{flex:1;overflow-y:auto;padding:8px 6px;}
.tpl-list::-webkit-scrollbar{width:3px;}
.tpl-list::-webkit-scrollbar-thumb{background:var(--c3);border-radius:2px;}
.tpl-sec{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--dim);padding:10px 6px 4px;}
.tpl-item{display:flex;align-items:center;gap:9px;padding:7px 8px;border-radius:9px;cursor:pointer;transition:background .12s;margin-bottom:1px;}
.tpl-item:hover{background:var(--c2);}
.tpl-item:active{background:var(--c3);}
.tpl-ico{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;font-size:15px;flex-shrink:0;}
.tpl-name{font-size:12.5px;font-weight:600;color:var(--text);}
.tpl-desc{font-size:10px;color:var(--sub);}

/* ‚îÄ‚îÄ CTX ‚îÄ‚îÄ */
#ctx{position:fixed;z-index:600;background:#15151c;border:1px solid var(--border2);border-radius:11px;padding:5px;min-width:176px;display:none;box-shadow:0 18px 55px rgba(0,0,0,.75);animation:ctx-in .1s ease;}
@keyframes ctx-in{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
.ctx-row{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:7px;font-size:12.5px;color:var(--text);cursor:pointer;transition:background .1s;}
.ctx-row:hover{background:rgba(255,255,255,.06);}
.ctx-row.red{color:var(--red);}
.ctx-row.red:hover{background:rgba(240,85,85,.1);}
.ctx-sep{height:1px;background:var(--border);margin:3px 0;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:300;padding:16px;}
.mbg.open{display:flex;}
.mbox{background:#13131a;border:1px solid var(--border2);border-radius:15px;overflow:hidden;box-shadow:0 28px 70px rgba(0,0,0,.85);animation:m-in .16s ease;width:100%;}
@keyframes m-in{from{transform:scale(.94);opacity:0}to{transform:scale(1);opacity:1}}
.mhd{display:flex;align-items:center;padding:13px 15px;border-bottom:1px solid var(--border);gap:8px;}
.mhd-title{flex:1;font-size:14px;font-weight:700;}
.mcl{width:26px;height:26px;border-radius:7px;border:none;background:var(--c2);color:var(--sub);font-size:15px;cursor:pointer;display:grid;place-items:center;}
.mcl:hover{background:var(--c3);color:var(--text);}
.mbd{padding:15px;}
.mft{display:flex;gap:7px;padding:0 15px 15px;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:0 13px;height:32px;border-radius:8px;font:600 12.5px var(--font);cursor:pointer;border:1px solid var(--border);background:var(--c2);color:var(--text);transition:all .12s;}
.btn:hover{background:var(--c3);}
.btn.blue{background:var(--blue);border-color:var(--blue);color:#fff;}
.btn.blue:hover{background:#3a7bf0;}
.mrow{display:flex;flex-direction:column;gap:12px;}
.mlbl{font-size:10.5px;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;display:block;}
.minput{width:100%;padding:8px 11px;border-radius:8px;border:1.5px solid var(--blue);background:rgba(255,255,255,.04);color:var(--text);font:13.5px var(--font);outline:none;}
.minput::placeholder{color:var(--dim);}
.mta{width:100%;min-height:80px;padding:9px 11px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);font:13px/1.6 var(--font);outline:none;resize:vertical;}
.mta:focus{border-color:var(--blue);}
.msel{width:100%;padding:8px 11px;border-radius:8px;border:1px solid var(--border);background:var(--c2);color:var(--text);font:13px var(--font);outline:none;cursor:pointer;}

/* editor modal */
#ed-modal{max-width:820px;height:min(640px,90vh);display:flex;flex-direction:column;}
#ed-modal .mbd{flex:1;display:flex;flex-direction:column;padding:0;min-height:0;}
#ed-ta{flex:1;min-height:0;background:transparent;border:none;outline:none;resize:none;color:var(--text);font:14px/1.8 var(--mono);padding:18px 20px;caret-color:var(--blue);}
#ed-ta::placeholder{color:var(--dim);}
#ed-ta::selection{background:rgba(79,143,255,.2);}
#ed-nm{flex:1;background:transparent;border:none;outline:none;font:700 14px var(--font);color:var(--text);caret-color:var(--blue);min-width:0;}
#ed-dot{width:6px;height:6px;border-radius:50%;background:transparent;transition:background .3s;flex-shrink:0;}
#ed-dot.dirty{background:var(--amber);}
#ed-dot.saved{background:var(--green);}
#ed-stat{font-size:10.5px;color:var(--dim);font-family:var(--mono);}

/* color swatches */
.swatch-row{display:flex;gap:6px;flex-wrap:wrap;}
.swatch{width:26px;height:26px;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:border-color .12s,transform .12s;}
.swatch:hover{transform:scale(1.1);}
.swatch.active{border-color:#fff;}

/* toast */
#toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%) translateY(8px);padding:8px 16px;border-radius:22px;background:rgba(18,18,24,.97);border:1px solid var(--border2);font-size:12.5px;font-weight:500;color:var(--text);opacity:0;transition:opacity .2s,transform .2s;pointer-events:none;white-space:nowrap;z-index:700;box-shadow:0 8px 28px rgba(0,0,0,.6);}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* color picker popup */
#cpick{position:fixed;z-index:700;background:#15151c;border:1px solid var(--border2);border-radius:11px;padding:10px;display:none;box-shadow:0 12px 40px rgba(0,0,0,.7);}

@media(max-width:600px){
  #toolbar{bottom:12px;gap:2px;padding:5px 5px;}
  .tb{padding:0 7px;font-size:11px;height:30px;}
  #ed-ta{font-size:16px;}
  #tpl-panel{width:100%;}
}
</style>
</head>
<body>

<div id="topbar">
  <div class="logo">clip<em>space</em></div>
  <button id="back-btn">‚Üê Back</button>
  <div id="bc"></div>
  <div class="top-right">
    <button class="top-btn" id="imp-btn">‚¨Ü Import</button>
    <button class="top-btn" id="exp-btn">‚¨á Export</button>
    <div id="zoom-lbl">100%</div>
  </div>
</div>

<div id="stage">
  <canvas id="grid-cvs"></canvas>
  <div id="world"></div>
</div>

<div id="toolbar">
  <button class="tb accent" id="tb-note">Ôºã Note</button>
  <button class="tb" id="tb-folder">üìÅ Folder</button>
  <button class="tb" id="tb-label">‚úè Label</button>
  <button class="tb" id="tb-sticky">üìå Sticky</button>
  <div class="tb-sep"></div>
  <button class="tb" id="tb-tpl">‚äû Templates</button>
  <div class="tb-sep"></div>
  <button class="tb" id="tb-zi">Ôºã</button>
  <button class="tb" id="tb-zo">Ôºç</button>
  <button class="tb" id="tb-fit">‚ä°</button>
  <div class="tb-sep"></div>
  <button class="tb" id="tb-del" style="color:var(--red)">üóë</button>
</div>

<!-- TEMPLATES PANEL -->
<div id="tpl-panel">
  <div class="tpl-hd">Templates</div>
  <div class="tpl-list" id="tpl-list"></div>
</div>

<!-- EDITOR -->
<div class="mbg" id="ed-bg">
  <div class="mbox" id="ed-modal">
    <div class="mhd">
      <div id="ed-dot"></div>
      <input id="ed-nm" type="text" placeholder="Untitled note" spellcheck="false">
      <span id="ed-stat"></span>
      <button class="mcl" id="ed-cl">‚úï</button>
    </div>
    <div class="mbd">
      <textarea id="ed-ta" placeholder="Start writing‚Ä¶" spellcheck="false"></textarea>
    </div>
  </div>
</div>

<!-- RENAME -->
<div class="mbg" id="rn-bg">
  <div class="mbox" style="max-width:340px;">
    <div class="mhd"><div class="mhd-title" id="rn-title">Rename</div><button class="mcl" id="rn-cl">‚úï</button></div>
    <div class="mbd mrow"><label class="mlbl">Name</label><input class="minput" id="rn-inp" type="text" autocomplete="off"></div>
    <div class="mft"><button class="btn" id="rn-cancel">Cancel</button><button class="btn blue" id="rn-ok">Rename</button></div>
  </div>
</div>

<!-- LABEL -->
<div class="mbg" id="lbl-bg">
  <div class="mbox" style="max-width:380px;">
    <div class="mhd"><div class="mhd-title">Add Label</div><button class="mcl" id="lbl-cl">‚úï</button></div>
    <div class="mbd mrow">
      <div><label class="mlbl">Text</label><input class="minput" id="lbl-inp" type="text" placeholder="Type a label‚Ä¶"></div>
      <div style="display:flex;gap:10px;">
        <div style="flex:1"><label class="mlbl">Size</label>
          <select class="msel" id="lbl-size"><option value="13">Small</option><option value="20" selected>Medium</option><option value="32">Large</option><option value="52">Huge</option></select>
        </div>
        <div style="flex:1"><label class="mlbl">Color</label>
          <select class="msel" id="lbl-color">
            <option value="#e8e8ee">White</option><option value="#4f8fff">Blue</option>
            <option value="#32d17a">Green</option><option value="#ffd060">Yellow</option>
            <option value="#9b6fff">Purple</option><option value="#ff6eb4">Pink</option><option value="#f05555">Red</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mft"><button class="btn" id="lbl-cancel">Cancel</button><button class="btn blue" id="lbl-ok">Add</button></div>
  </div>
</div>

<!-- STICKY -->
<div class="mbg" id="sty-bg">
  <div class="mbox" style="max-width:380px;">
    <div class="mhd"><div class="mhd-title">Sticky Note</div><button class="mcl" id="sty-cl">‚úï</button></div>
    <div class="mbd mrow">
      <div><label class="mlbl">Text</label><textarea class="mta" id="sty-inp" placeholder="Write your sticky note‚Ä¶" rows="3"></textarea></div>
      <div><label class="mlbl">Color</label>
        <div class="swatch-row" id="sty-swatches">
          <div class="swatch active" data-c="#ffd060" style="background:#ffd060"></div>
          <div class="swatch" data-c="#a8f0c6" style="background:#a8f0c6"></div>
          <div class="swatch" data-c="#ffa8d5" style="background:#ffa8d5"></div>
          <div class="swatch" data-c="#a8ccff" style="background:#a8ccff"></div>
          <div class="swatch" data-c="#d4a8ff" style="background:#d4a8ff"></div>
          <div class="swatch" data-c="#ffc8a8" style="background:#ffc8a8"></div>
        </div>
      </div>
    </div>
    <div class="mft"><button class="btn" id="sty-cancel">Cancel</button><button class="btn blue" id="sty-ok">Add</button></div>
  </div>
</div>

<!-- SHAPE -->
<div class="mbg" id="shp-bg">
  <div class="mbox" style="max-width:400px;">
    <div class="mhd"><div class="mhd-title">Add Shape</div><button class="mcl" id="shp-cl">‚úï</button></div>
    <div class="mbd mrow">
      <div><label class="mlbl">Shape</label>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;" id="shp-grid"></div>
      </div>
      <div style="display:flex;gap:10px;">
        <div style="flex:1"><label class="mlbl">Fill color</label>
          <div class="swatch-row" id="shp-fill-swatches"></div>
        </div>
        <div style="flex:1"><label class="mlbl">Stroke color</label>
          <div class="swatch-row" id="shp-stroke-swatches"></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;">
        <div style="flex:1"><label class="mlbl">Stroke width</label>
          <select class="msel" id="shp-sw"><option value="1.5">Thin</option><option value="2.5" selected>Normal</option><option value="4">Thick</option><option value="6">Heavy</option></select>
        </div>
        <div style="flex:1"><label class="mlbl">Size</label>
          <select class="msel" id="shp-sz"><option value="80">Small</option><option value="120" selected>Medium</option><option value="200">Large</option><option value="300">Huge</option></select>
        </div>
      </div>
    </div>
    <div class="mft"><button class="btn" id="shp-cancel">Cancel</button><button class="btn blue" id="shp-ok">Add shape</button></div>
  </div>
</div>

<!-- CTX MENU -->
<div id="ctx">
  <div class="ctx-row" id="ctx-open">üìÇ Open folder</div>
  <div class="ctx-row" id="ctx-edit">‚úèÔ∏è Edit note</div>
  <div class="ctx-row" id="ctx-rename">üî§ Rename</div>
  <div class="ctx-row" id="ctx-copy">üìã Copy text</div>
  <div class="ctx-row" id="ctx-dup">‚ßâ Duplicate</div>
  <div class="ctx-row" id="ctx-color">üé® Change color</div>
  <div class="ctx-sep"></div>
  <div class="ctx-row red" id="ctx-del">üóë Delete</div>
</div>

<!-- COLOR PICKER POPUP -->
<div id="cpick">
  <div class="swatch-row" style="max-width:152px;"></div>
</div>

<!-- IMPORT FILE INPUT (hidden) -->
<input type="file" id="imp-file" accept=".json" style="display:none">

<!-- TOAST -->
<div id="toast"></div>

<script>
(function(){
'use strict';

var DB_KEY='cs4';
var uid=function(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);};
var ts=function(){return Date.now();};
var ge=function(id){return document.getElementById(id);};
var clamp=function(v,a,b){return Math.max(a,Math.min(b,v));};
var esc=function(s){return String(s||'').replace(/[&<>"]/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];});};
var ago=function(t){var d=(Date.now()-t)/1000;if(d<60)return 'now';if(d<3600)return Math.floor(d/60)+'m';if(d<86400)return Math.floor(d/3600)+'h';return new Date(t).toLocaleDateString(undefined,{month:'short',day:'numeric'});};

/* ‚îÄ‚îÄ DB ‚îÄ‚îÄ */
function newDB(){
  var r=uid();
  return{ver:5,root:r,current:r,
    nodes:{[r]:{id:r,type:'folder',name:'My Board',parent:null,kids:[],t:ts()}},
    pos:{[r]:{}},views:{}};
}
function loadDB(){
  try{
    var d=JSON.parse(localStorage.getItem(DB_KEY)||'null');
    if(!d||!d.root||!d.nodes||!d.nodes[d.root])return newDB();
    if(!d.pos)d.pos={};if(!d.views)d.views={};if(!d.current)d.current=d.root;
    return d;
  }catch(e){return newDB();}
}
function saveDB(){try{localStorage.setItem(DB_KEY,JSON.stringify(DB));}catch(e){toast('‚ö† Storage full ‚Äî try exporting and clearing');}}

var DB=loadDB();
function nod(id){return DB.nodes[id];}
function posOf(fid,id){if(!DB.pos[fid])DB.pos[fid]={};return DB.pos[fid][id]||null;}
function setPos(fid,id,x,y,w,h){
  if(!DB.pos[fid])DB.pos[fid]={};
  var old=DB.pos[fid][id]||{};
  DB.pos[fid][id]={x:x,y:y,w:w!==undefined?w:old.w||null,h:h!==undefined?h:old.h||null};
}
function setSz(fid,id,w,h){
  if(!DB.pos[fid])DB.pos[fid]={};
  var old=DB.pos[fid][id]||{x:0,y:0};
  DB.pos[fid][id]={x:old.x,y:old.y,w:w,h:h};
}

/* ‚îÄ‚îÄ VIEW ‚îÄ‚îÄ */
var V={tx:0,ty:0,scale:1};
var MIN_SCALE=0.07,MAX_SCALE=20;
var worldEl=ge('world'),stageEl=ge('stage');
var gridCvs=ge('grid-cvs'),gridCtx=gridCvs.getContext('2d');
var _gRaf=null;

function applyView(){
  worldEl.style.transform='translate('+V.tx+'px,'+V.ty+'px) scale('+V.scale+')';
  ge('zoom-lbl').textContent=Math.round(V.scale*100)+'%';
  if(!_gRaf)_gRaf=requestAnimationFrame(function(){_gRaf=null;drawGrid();});
}

function drawGrid(){
  var W=window.innerWidth,H=window.innerHeight;
  if(gridCvs.width!==W)gridCvs.width=W;
  if(gridCvs.height!==H)gridCvs.height=H;
  gridCtx.clearRect(0,0,W,H);
  var sp=28*V.scale;
  while(sp<14)sp*=2;while(sp>80)sp/=2;
  var ox=((V.tx%sp)+sp)%sp,oy=((V.ty%sp)+sp)%sp;
  gridCtx.fillStyle='rgba(255,255,255,0.042)';
  for(var x=ox;x<W+sp;x+=sp)for(var y=oy;y<H+sp;y+=sp)gridCtx.fillRect(x-1,y-1,2,2);
}

function s2w(sx,sy){return{x:(sx-V.tx)/V.scale,y:(sy-V.ty)/V.scale};}
function zoomAt(cx,cy,f){var b=s2w(cx,cy);V.scale=clamp(V.scale*f,MIN_SCALE,MAX_SCALE);V.tx=cx-b.x*V.scale;V.ty=cy-b.y*V.scale;applyView();}

function fitAll(){
  var folder=nod(DB.current);
  var kids=(folder.kids||[]).map(function(id){return nod(id);}).filter(Boolean);
  if(!kids.length){V.scale=1;V.tx=window.innerWidth/2-100;V.ty=(window.innerHeight+48)/2-80;applyView();return;}
  var xs=[],ys=[];
  kids.forEach(function(n){
    var p=posOf(DB.current,n.id)||{x:0,y:0,w:null,h:null};
    var w=p.w||defW(n),h=p.h||120;
    xs.push(p.x,p.x+w);ys.push(p.y,p.y+h);
  });
  var x0=Math.min.apply(null,xs)-60,y0=Math.min.apply(null,ys)-60;
  var bw=(Math.max.apply(null,xs)+60)-x0,bh=(Math.max.apply(null,ys)+60)-y0;
  var sw=window.innerWidth,sh=window.innerHeight-100;
  V.scale=clamp(Math.min(sw/bw,sh/bh),MIN_SCALE,MAX_SCALE);
  V.tx=sw/2-(x0+bw/2)*V.scale;V.ty=(sh/2+48)-(y0+bh/2)*V.scale;
  applyView();
}

function defW(n){return n.type==='folder'?160:n.type==='label'?200:n.type==='shape'?140:210;}
function saveView(){DB.views[DB.current]={tx:V.tx,ty:V.ty,scale:V.scale};}
function restoreView(fid){var v=DB.views[fid];if(v){V.tx=v.tx;V.ty=v.ty;V.scale=v.scale;applyView();}else{V.scale=1;setTimeout(fitAll,30);}}

/* ‚îÄ‚îÄ BREADCRUMB + BACK BUTTON ‚îÄ‚îÄ */
function renderBC(){
  var bc=ge('bc');bc.innerHTML='';
  var path=[],cur=nod(DB.current);
  while(cur){path.unshift(cur);cur=cur.parent?nod(cur.parent):null;}

  // show back button when not at root
  var bb=ge('back-btn');
  if(DB.current!==DB.root){
    bb.style.display='flex';
    var parentId=nod(DB.current).parent||DB.root;
    bb.onclick=function(){navTo(parentId);};
  } else {
    bb.style.display='none';
  }

  path.forEach(function(n,i){
    var s=document.createElement('span');
    s.className='bc-node'+(i===path.length-1?' cur':'');
    s.textContent=n.name;
    if(i<path.length-1)s.addEventListener('click',function(){navTo(n.id);});
    bc.appendChild(s);
    if(i<path.length-1){var sep=document.createElement('span');sep.className='bc-sep';sep.textContent='/';bc.appendChild(sep);}
  });
}

/* ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ */
var sel=null;
function setSel(id){sel=id;worldEl.querySelectorAll('.card').forEach(function(el){el.classList.toggle('sel',el.dataset.id===id);});}
function clearSel(){sel=null;worldEl.querySelectorAll('.card').forEach(function(el){el.classList.remove('sel');});}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function render(){
  worldEl.querySelectorAll('.card').forEach(function(el){el.remove();});
  renderBC();
  var folder=nod(DB.current);if(!folder)return;
  (folder.kids||[]).forEach(function(id){
    var n=nod(id);if(!n)return;
    var p=posOf(DB.current,id);
    if(!p){var a=Math.random()*Math.PI*2,r=120+Math.random()*160;setPos(DB.current,id,Math.cos(a)*r-90,Math.sin(a)*r-55,null,null);p=posOf(DB.current,id);}
    var el=buildCard(n,p);
    el.style.left=p.x+'px';el.style.top=p.y+'px';
    if(p.w&&n.type!=='label')el.style.width=p.w+'px';
    if(p.h&&n.type!=='label'&&n.type!=='shape')el.style.height=p.h+'px';
    el.dataset.id=id;
    if(sel===id)el.classList.add('sel');
    attachDrag(el,n);
    if(n.type!=='label'&&n.type!=='shape')attachResize(el,n);
    worldEl.appendChild(el);
  });
}

var RH_SVG='<svg width="10" height="10" viewBox="0 0 10 10"><path d="M9 1L1 9M5 1L1 5M9 5L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';

function buildCard(n,p){
  var el=document.createElement('div');
  if(n.type==='note'){
    el.className='card cn';
    var preview=(n.text||'').replace(/\s+/g,' ').slice(0,200);
    el.innerHTML='<div class="cn-head"><div class="cn-title">'+esc(n.name)+'</div></div>'
      +(preview?'<div class="cn-body">'+esc(preview)+'</div>':'')
      +'<div class="cn-foot">'+ago(n.t)+'</div>'
      +'<div class="rh">'+RH_SVG+'</div>';
  } else if(n.type==='folder'){
    el.className='card cf';
    var cnt=(n.kids||[]).length;
    el.innerHTML='<div class="cf-ico">üìÅ</div><div class="cf-name">'+esc(n.name)+'</div>'
      +'<div class="cf-meta">'+cnt+' item'+(cnt!==1?'s':'')+'</div>'
      +'<div class="cf-hint">Click to open ‚Üí</div>'
      +'<div class="rh">'+RH_SVG+'</div>';
  } else if(n.type==='label'){
    /* LABEL FIX: size is in canvas-space px, so we don't fight zoom */
    el.className='card cl';
    el.style.width='';el.style.height='';
    el.innerHTML='<div class="cl-text" style="font-size:'+n.size+'px;color:'+n.color+';">'+esc(n.name)+'</div>';
  } else if(n.type==='sticky'){
    el.className='card cs';
    el.style.background=n.color||'#ffd060';el.style.borderColor='rgba(0,0,0,0.07)';
    el.innerHTML='<div class="cs-inner">'+esc(n.text||'')+'</div>'
      +'<div class="cs-foot">'+ago(n.t)+'</div>'
      +'<div class="rh">'+RH_SVG+'</div>';
  } else if(n.type==='checklist'){
    el.className='card cch';
    var items=(n.items||[]).map(function(it,i){
      return '<div class="cch-item'+(it.done?' done-item':'')+'"><div class="cch-box'+(it.done?' done':'')+'" data-idx="'+i+'"></div><span class="cch-label">'+esc(it.t)+'</span></div>';
    }).join('');
    el.innerHTML='<div class="cch-title">'+esc(n.name)+'</div>'+items+'<div class="rh">'+RH_SVG+'</div>';
    el.querySelectorAll('.cch-box').forEach(function(box){
      box.addEventListener('click',function(e){e.stopPropagation();n.items[parseInt(box.dataset.idx)].done=!n.items[parseInt(box.dataset.idx)].done;n.t=ts();saveDB();render();setSel(n.id);});
    });
  } else if(n.type==='link'){
    el.className='card clk';
    el.innerHTML='<div class="clk-title">'+esc(n.name)+'</div>'
      +'<div class="clk-url">'+esc(n.url||'')+'</div>'
      +(n.desc?'<div class="clk-desc">'+esc(n.desc)+'</div>':'')
      +'<div class="rh">'+RH_SVG+'</div>';
    el.querySelector('.clk-url').addEventListener('click',function(e){e.stopPropagation();window.open(n.url,'_blank');});
  } else if(n.type==='shape'){
    el.className='card cshp';
    var sz=p.w||n.sz||120;
    el.style.width=sz+'px';el.style.height=sz+'px';
    el.style.background='transparent';el.style.border='none';
    el.innerHTML=buildShapeSVG(n,sz);
  }
  return el;
}

/* ‚îÄ‚îÄ SHAPES ‚îÄ‚îÄ */
var SHAPES=[
  {id:'rect',label:'Rectangle',icon:'‚ñ≠'},
  {id:'circle',label:'Circle',icon:'‚óØ'},
  {id:'triangle',label:'Triangle',icon:'‚ñ≥'},
  {id:'diamond',label:'Diamond',icon:'‚óá'},
  {id:'star',label:'Star',icon:'‚òÜ'},
  {id:'arrow-r',label:'Arrow ‚Üí',icon:'‚Üí'},
  {id:'arrow-l',label:'Arrow ‚Üê',icon:'‚Üê'},
  {id:'line-h',label:'Line ‚Äî',icon:'‚Äî'},
  {id:'line-v',label:'Line |',icon:'|'},
  {id:'line-d',label:'Line ‚Üò',icon:'‚Üò'},
  {id:'line-dl',label:'Line ‚Üô',icon:'‚Üô'},
  {id:'bracket',label:'Bracket [ ]',icon:'[]'},
];

function buildShapeSVG(n,sz){
  var f=n.fill||'none',s=n.stroke||'#4f8fff',sw=n.sw||2.5;
  var h=sz,p=sw/2;
  var svg='<svg width="'+sz+'" height="'+h+'" viewBox="0 0 '+sz+' '+h+'" xmlns="http://www.w3.org/2000/svg" style="display:block;overflow:visible;">';
  var shp=n.shape||'rect';
  if(shp==='rect'){svg+='<rect x="'+p+'" y="'+p+'" width="'+(sz-sw)+'" height="'+(h-sw)+'" fill="'+f+'" stroke="'+s+'" stroke-width="'+sw+'" rx="4"/>';}
  else if(shp==='circle'){var r=(sz-sw)/2;svg+='<circle cx="'+(sz/2)+'" cy="'+(h/2)+'" r="'+r+'" fill="'+f+'" stroke="'+s+'" stroke-width="'+sw+'"/>';}
  else if(shp==='triangle'){svg+='<polygon points="'+(sz/2)+','+p+' '+(sz-p)+','+(h-p)+' '+p+','+(h-p)+'" fill="'+f+'" stroke="'+s+'" stroke-width="'+sw+'"/>';}
  else if(shp==='diamond'){svg+='<polygon points="'+(sz/2)+','+p+' '+(sz-p)+','+(h/2)+' '+(sz/2)+','+(h-p)+' '+p+','+(h/2)+'" fill="'+f+'" stroke="'+s+'" stroke-width="'+sw+'"/>';}
  else if(shp==='star'){
    var cx=sz/2,cy=h/2,ro=(sz-sw)/2,ri=ro*0.42,pts='';
    for(var i=0;i<10;i++){var ang=Math.PI/5*i-Math.PI/2,r2=i%2===0?ro:ri;pts+=(cx+r2*Math.cos(ang)).toFixed(2)+','+(cy+r2*Math.sin(ang)).toFixed(2)+(i<9?' ':'');}
    svg+='<polygon points="'+pts+'" fill="'+f+'" stroke="'+s+'" stroke-width="'+sw+'"/>';
  }
  else if(shp==='arrow-r'){var m=h/2;svg+='<polyline points="'+p+','+m+' '+(sz-p)+','+m+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/><polyline points="'+(sz-p-16)+','+(m-12)+' '+(sz-p)+','+m+' '+(sz-p-16)+','+(m+12)+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round" stroke-linejoin="round"/>';}
  else if(shp==='arrow-l'){var m2=h/2;svg+='<polyline points="'+(sz-p)+','+m2+' '+p+','+m2+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/><polyline points="'+(p+16)+','+(m2-12)+' '+p+','+m2+' '+(p+16)+','+(m2+12)+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round" stroke-linejoin="round"/>';}
  else if(shp==='line-h'){svg+='<line x1="'+p+'" y1="'+(h/2)+'" x2="'+(sz-p)+'" y2="'+(h/2)+'" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/>';}
  else if(shp==='line-v'){svg+='<line x1="'+(sz/2)+'" y1="'+p+'" x2="'+(sz/2)+'" y2="'+(h-p)+'" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/>';}
  else if(shp==='line-d'){svg+='<line x1="'+p+'" y1="'+p+'" x2="'+(sz-p)+'" y2="'+(h-p)+'" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/>';}
  else if(shp==='line-dl'){svg+='<line x1="'+(sz-p)+'" y1="'+p+'" x2="'+p+'" y2="'+(h-p)+'" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round"/>';}
  else if(shp==='bracket'){svg+='<path d="M'+(sz*0.35)+','+p+' L'+p+','+p+' L'+p+','+(h-p)+' L'+(sz*0.35)+','+(h-p)+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round" stroke-linejoin="round"/><path d="M'+(sz*0.65)+','+p+' L'+(sz-p)+','+p+' L'+(sz-p)+','+(h-p)+' L'+(sz*0.65)+','+(h-p)+'" fill="none" stroke="'+s+'" stroke-width="'+sw+'" stroke-linecap="round" stroke-linejoin="round"/>';}
  svg+='</svg>';
  return svg;
}

/* shape resize rebuilds SVG */
function attachShapeResize(el,n){
  var rh=document.createElement('div');rh.className='rh';rh.innerHTML=RH_SVG;el.appendChild(rh);
  var isRes=false,startX,startY,startSz;
  rh.addEventListener('pointerdown',function(e){e.stopPropagation();e.preventDefault();isRes=true;rh.setPointerCapture(e.pointerId);startX=e.clientX;startY=e.clientY;startSz=parseInt(el.style.width)||n.sz||120;});
  rh.addEventListener('pointermove',function(e){
    if(!isRes)return;
    var d=((e.clientX-startX)+(e.clientY-startY))/V.scale;
    var sz=Math.max(40,startSz+d);
    el.style.width=sz+'px';el.style.height=sz+'px';
    el.innerHTML=buildShapeSVG(n,sz);el.appendChild(rh);
    setSz(DB.current,n.id,sz,sz);
  });
  rh.addEventListener('pointerup',function(){if(!isRes)return;isRes=false;saveDB();});
}

/* ‚îÄ‚îÄ DRAG ‚îÄ‚îÄ */
function attachDrag(el,n){
  var dragging=false,moved=false,startWX,startWY,startPX,startPY;
  var rh=el.querySelector('.rh');
  el.addEventListener('pointerdown',function(e){
    if(e.button!==0)return;
    if(rh&&rh.contains(e.target))return;
    if(e.target.closest('.cch-box'))return;
    if(e.target.closest('.clk-url'))return;
    e.stopPropagation();e.preventDefault();
    setSel(n.id);dragging=true;moved=false;
    el.classList.add('dragging');el.setPointerCapture(e.pointerId);
    var wp=s2w(e.clientX,e.clientY);startWX=wp.x;startWY=wp.y;
    var p=posOf(DB.current,n.id);startPX=p.x;startPY=p.y;
  });
  el.addEventListener('pointermove',function(e){
    if(!dragging)return;
    var wp=s2w(e.clientX,e.clientY);var dx=wp.x-startWX,dy=wp.y-startWY;
    if(Math.abs(dx)>2||Math.abs(dy)>2)moved=true;
    if(!moved)return;
    var nx=startPX+dx,ny=startPY+dy;
    var old=posOf(DB.current,n.id);
    DB.pos[DB.current][n.id]={x:nx,y:ny,w:old.w,h:old.h};
    el.style.left=nx+'px';el.style.top=ny+'px';
  });
  el.addEventListener('pointerup',function(){
    el.classList.remove('dragging');dragging=false;
    if(moved){saveDB();return;}
    if(n.type==='folder')navTo(n.id);
    else if(n.type==='note')openEditor(n.id);
  });
  el.addEventListener('contextmenu',function(e){e.preventDefault();e.stopPropagation();setSel(n.id);showCtx(e.clientX,e.clientY,n.id);});

  // attach shape resize separately (SVG cards)
  if(n.type==='shape')attachShapeResize(el,n);
}

/* ‚îÄ‚îÄ RESIZE (non-shape) ‚îÄ‚îÄ */
function attachResize(el,n){
  var rh=el.querySelector('.rh');if(!rh)return;
  var isRes=false,startX,startY,startW,startH;
  rh.addEventListener('pointerdown',function(e){e.stopPropagation();e.preventDefault();isRes=true;rh.setPointerCapture(e.pointerId);startX=e.clientX;startY=e.clientY;startW=el.offsetWidth;startH=el.offsetHeight;});
  rh.addEventListener('pointermove',function(e){
    if(!isRes)return;
    var nw=Math.max(120,startW+(e.clientX-startX)/V.scale);
    var nh=Math.max(60,startH+(e.clientY-startY)/V.scale);
    el.style.width=nw+'px';el.style.height=nh+'px';
    setSz(DB.current,n.id,nw,nh);
  });
  rh.addEventListener('pointerup',function(){if(!isRes)return;isRes=false;saveDB();});
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
function navTo(fid){saveView();DB.current=fid;sel=null;restoreView(fid);render();}

/* ‚îÄ‚îÄ DROP POSITION ‚îÄ‚îÄ */
function dropPos(w,h){
  var cx=window.innerWidth/2+(Math.random()-.5)*80;
  var cy=(window.innerHeight+48)/2+(Math.random()-.5)*60;
  var wp=s2w(cx,cy);return{x:wp.x-(w/2),y:wp.y-(h/2)};
}

/* ‚îÄ‚îÄ CREATE NODES ‚îÄ‚îÄ */
function mkNote(){
  var id=uid(),p=dropPos(210,100);
  DB.nodes[id]={id:id,type:'note',name:'Untitled',parent:DB.current,text:'',t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);openEditor(id);
}
function mkFolder(){
  var id=uid(),p=dropPos(160,130);
  DB.nodes[id]={id:id,type:'folder',name:'New Folder',parent:DB.current,kids:[],t:ts()};
  nod(DB.current).kids.push(id);DB.pos[id]={};setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);doRename(id);
}
function mkLabel(txt,size,color){
  var id=uid(),p=dropPos(180,50);
  DB.nodes[id]={id:id,type:'label',name:txt,parent:DB.current,size:size,color:color,t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);closeModals();
}
function mkSticky(txt,color){
  var id=uid(),p=dropPos(180,110);
  DB.nodes[id]={id:id,type:'sticky',name:'sticky',text:txt,color:color,parent:DB.current,t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);closeModals();
}
function mkChecklist(name,items){
  var id=uid(),p=dropPos(210,140);
  DB.nodes[id]={id:id,type:'checklist',name:name,items:items,parent:DB.current,t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);
}
function mkLink(title,url,desc){
  var id=uid(),p=dropPos(220,90);
  DB.nodes[id]={id:id,type:'link',name:title,url:url,desc:desc||'',parent:DB.current,t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);
  saveDB();render();setSel(id);
}
function mkShape(shape,fill,stroke,sw,sz){
  var id=uid(),p=dropPos(sz,sz);
  DB.nodes[id]={id:id,type:'shape',shape:shape,fill:fill,stroke:stroke,sw:sw,sz:sz,name:shape,parent:DB.current,t:ts()};
  nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,sz,sz);
  saveDB();render();setSel(id);closeModals();
}
function delNode(id){
  var n=nod(id);if(!n)return;
  if(!confirm('Delete "'+n.name+'"?'))return;
  function rm(nid){var x=nod(nid);if(!x)return;if(x.type==='folder')(x.kids||[]).forEach(rm);delete DB.nodes[nid];delete DB.pos[nid];}
  if(n.parent&&nod(n.parent)){nod(n.parent).kids=(nod(n.parent).kids||[]).filter(function(k){return k!==id;});if(DB.pos[n.parent])delete DB.pos[n.parent][id];}
  rm(id);if(sel===id)sel=null;if(openFileId===id)closeEditor(true);
  saveDB();render();toast('Deleted');
}
function dupNode(id){
  var n=nod(id);if(!n||n.type==='folder')return;
  var nid=uid(),copy=JSON.parse(JSON.stringify(n));copy.id=nid;copy.t=ts();copy.parent=DB.current;
  DB.nodes[nid]=copy;nod(DB.current).kids.push(nid);
  var p=posOf(DB.current,id)||{x:0,y:0,w:null,h:null};
  setPos(DB.current,nid,p.x+28,p.y+28,p.w,p.h);
  saveDB();render();setSel(nid);toast('Duplicated');
}

/* ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ */
var openFileId=null,edDirty=false,edTimer=null;
function openEditor(id){
  var n=nod(id);if(!n||n.type!=='note')return;
  if(edDirty&&openFileId)flushEd();
  openFileId=id;edDirty=false;
  ge('ed-nm').value=n.name;ge('ed-ta').value=n.text||'';
  updateEdStat();ge('ed-dot').className='saved';
  ge('ed-bg').classList.add('open');setTimeout(function(){ge('ed-ta').focus();},80);
}
function closeEditor(silent){if(!silent&&edDirty&&openFileId)flushEd();openFileId=null;edDirty=false;ge('ed-bg').classList.remove('open');}
function flushEd(){
  if(!openFileId)return;var n=nod(openFileId);if(!n)return;
  n.text=ge('ed-ta').value;n.name=ge('ed-nm').value.trim()||n.name;n.t=ts();
  edDirty=false;ge('ed-dot').className='saved';saveDB();render();
}
function updateEdStat(){var v=ge('ed-ta').value,w=v.trim()?v.trim().split(/\s+/).length:0;ge('ed-stat').textContent=w+'w ¬∑ '+v.length+'c';}
ge('ed-ta').addEventListener('input',function(){edDirty=true;ge('ed-dot').className='dirty';updateEdStat();clearTimeout(edTimer);edTimer=setTimeout(function(){if(edDirty)flushEd();},900);});
ge('ed-nm').addEventListener('input',function(){edDirty=true;ge('ed-dot').className='dirty';});
ge('ed-nm').addEventListener('change',function(){if(openFileId)flushEd();});
ge('ed-cl').addEventListener('click',function(){flushEd();closeEditor(true);});
ge('ed-bg').addEventListener('click',function(e){if(e.target===ge('ed-bg')){flushEd();closeEditor(true);}});

/* ‚îÄ‚îÄ RENAME ‚îÄ‚îÄ */
var rnId=null;
function doRename(id){rnId=id;var n=nod(id);ge('rn-title').textContent='Rename '+n.type;ge('rn-inp').value=n.name;ge('rn-bg').classList.add('open');setTimeout(function(){ge('rn-inp').focus();ge('rn-inp').select();},80);}
function commitRename(){if(!rnId)return;var v=ge('rn-inp').value.trim();if(!v)return;nod(rnId).name=v;nod(rnId).t=ts();if(openFileId===rnId)ge('ed-nm').value=v;saveDB();render();ge('rn-bg').classList.remove('open');toast('Renamed');}
ge('rn-ok').addEventListener('click',commitRename);ge('rn-cancel').addEventListener('click',function(){ge('rn-bg').classList.remove('open');});
ge('rn-cl').addEventListener('click',function(){ge('rn-bg').classList.remove('open');});
ge('rn-bg').addEventListener('click',function(e){if(e.target===ge('rn-bg'))ge('rn-bg').classList.remove('open');});
ge('rn-inp').addEventListener('keydown',function(e){if(e.key==='Enter')commitRename();if(e.key==='Escape')ge('rn-bg').classList.remove('open');});

/* ‚îÄ‚îÄ LABEL MODAL ‚îÄ‚îÄ */
ge('lbl-ok').addEventListener('click',function(){var t=ge('lbl-inp').value.trim();if(!t)return;mkLabel(t,parseInt(ge('lbl-size').value),ge('lbl-color').value);ge('lbl-inp').value='';});
ge('lbl-cancel').addEventListener('click',function(){ge('lbl-bg').classList.remove('open');});ge('lbl-cl').addEventListener('click',function(){ge('lbl-bg').classList.remove('open');});
ge('lbl-bg').addEventListener('click',function(e){if(e.target===ge('lbl-bg'))ge('lbl-bg').classList.remove('open');});
ge('lbl-inp').addEventListener('keydown',function(e){if(e.key==='Enter')ge('lbl-ok').click();});

/* ‚îÄ‚îÄ STICKY MODAL ‚îÄ‚îÄ */
var _styC='#ffd060';
ge('sty-swatches').querySelectorAll('.swatch').forEach(function(sw){
  sw.addEventListener('click',function(){ge('sty-swatches').querySelectorAll('.swatch').forEach(function(s){s.classList.remove('active');});sw.classList.add('active');_styC=sw.dataset.c;});
});
ge('sty-ok').addEventListener('click',function(){var t=ge('sty-inp').value.trim();if(!t)return;mkSticky(t,_styC);ge('sty-inp').value='';});
ge('sty-cancel').addEventListener('click',function(){ge('sty-bg').classList.remove('open');});ge('sty-cl').addEventListener('click',function(){ge('sty-bg').classList.remove('open');});
ge('sty-bg').addEventListener('click',function(e){if(e.target===ge('sty-bg'))ge('sty-bg').classList.remove('open');});

/* ‚îÄ‚îÄ SHAPE MODAL ‚îÄ‚îÄ */
var _shpSel='rect',_shpFill='none',_shpStroke='#4f8fff';
var shapeSwatchColors=['none','#ffffff','#ffd060','#32d17a','#4f8fff','#f05555','#9b6fff','#ff6eb4','#1c1c22'];

function buildShapeGrid(){
  var grid=ge('shp-grid');grid.innerHTML='';
  SHAPES.forEach(function(sh){
    var btn=document.createElement('button');
    btn.style.cssText='display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px 4px;border-radius:9px;border:1.5px solid var(--border);background:var(--c2);color:var(--text);cursor:pointer;font-size:20px;transition:all .12s;';
    btn.innerHTML=sh.icon+'<span style="font-size:9px;color:var(--sub);">'+sh.label+'</span>';
    btn.dataset.sh=sh.id;
    btn.addEventListener('click',function(){
      grid.querySelectorAll('button').forEach(function(b){b.style.borderColor='var(--border)';b.style.background='var(--c2)';});
      btn.style.borderColor='var(--blue)';btn.style.background='var(--blue-a)';_shpSel=sh.id;
    });
    if(sh.id===_shpSel){btn.style.borderColor='var(--blue)';btn.style.background='var(--blue-a)';}
    grid.appendChild(btn);
  });
}

function buildShapeSwatches(containerId,current,setter){
  var c=ge(containerId);c.innerHTML='';
  shapeSwatchColors.forEach(function(col){
    var sw=document.createElement('div');sw.className='swatch'+(col===current?' active':'');
    if(col==='none'){sw.style.cssText='width:26px;height:26px;border-radius:7px;cursor:pointer;border:2px solid var(--border2);background:transparent;position:relative;overflow:hidden;';
      sw.innerHTML='<svg width="26" height="26" style="position:absolute;inset:0"><line x1="0" y1="0" x2="26" y2="26" stroke="#f05555" stroke-width="1.5"/></svg>';}
    else sw.style.cssText='width:26px;height:26px;border-radius:7px;cursor:pointer;border:2px solid transparent;background:'+col+';';
    if(col===current)sw.style.borderColor='#fff';
    sw.addEventListener('click',function(){
      c.querySelectorAll('.swatch').forEach(function(s){s.style.borderColor='transparent';s.classList.remove('active');});
      sw.style.borderColor='#fff';sw.classList.add('active');setter(col);
    });
    c.appendChild(sw);
  });
}

ge('tb-tpl').addEventListener('click',function(){
  ge('shp-bg').classList.remove('open');
  var open=!ge('tpl-panel').classList.contains('open');
  ge('tpl-panel').classList.toggle('open',open);
  ge('tb-tpl').classList.toggle('active',open);
});

ge('shp-ok').addEventListener('click',function(){
  var sw=parseFloat(ge('shp-sw').value);var sz=parseInt(ge('shp-sz').value);
  mkShape(_shpSel,_shpFill,_shpStroke,sw,sz);ge('shp-bg').classList.remove('open');
});
ge('shp-cancel').addEventListener('click',function(){ge('shp-bg').classList.remove('open');});
ge('shp-cl').addEventListener('click',function(){ge('shp-bg').classList.remove('open');});
ge('shp-bg').addEventListener('click',function(e){if(e.target===ge('shp-bg'))ge('shp-bg').classList.remove('open');});

function openShapeModal(){
  buildShapeGrid();
  buildShapeSwatches('shp-fill-swatches',_shpFill,function(c){_shpFill=c;});
  buildShapeSwatches('shp-stroke-swatches',_shpStroke,function(c){_shpStroke=c;});
  ge('shp-bg').classList.add('open');
}

/* ‚îÄ‚îÄ CTX MENU ‚îÄ‚îÄ */
var ctxId=null,ctxEl=ge('ctx');
function showCtx(x,y,id){
  ctxId=id;var n=nod(id);
  ge('ctx-open').style.display=n.type==='folder'?'':'none';
  ge('ctx-edit').style.display=n.type==='note'?'':'none';
  ge('ctx-copy').style.display=n.type==='note'?'':'none';
  ge('ctx-dup').style.display=n.type==='folder'?'none':'';
  ge('ctx-color').style.display=(n.type==='sticky'||n.type==='label')? '':'none';
  ctxEl.style.display='block';
  ctxEl.style.left=Math.min(x,window.innerWidth-185)+'px';ctxEl.style.top=Math.min(y,window.innerHeight-220)+'px';
}
function hideCtx(){ctxEl.style.display='none';ctxId=null;}
document.addEventListener('click',hideCtx);
ge('ctx-open').addEventListener('click',function(){if(ctxId)navTo(ctxId);hideCtx();});
ge('ctx-edit').addEventListener('click',function(){if(ctxId)openEditor(ctxId);hideCtx();});
ge('ctx-rename').addEventListener('click',function(){if(ctxId)doRename(ctxId);hideCtx();});
ge('ctx-copy').addEventListener('click',function(){var n=ctxId&&nod(ctxId);if(n&&n.text)navigator.clipboard.writeText(n.text).then(function(){toast('Copied!');});hideCtx();});
ge('ctx-dup').addEventListener('click',function(){if(ctxId)dupNode(ctxId);hideCtx();});
ge('ctx-del').addEventListener('click',function(){if(ctxId)delNode(ctxId);hideCtx();});
ge('ctx-color').addEventListener('click',function(){if(ctxId)showCpick(ctxId);hideCtx();});

/* ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ */
var cpickColors=['#ffd060','#a8f0c6','#ffa8d5','#a8ccff','#d4a8ff','#ffc8a8','#f05555','#4f8fff','#32d17a','#e8e8ee','#1c1c22'];
var cpEl=ge('cpick'),cpRow=cpEl.querySelector('div');
cpickColors.forEach(function(c){
  var sw=document.createElement('div');sw.className='swatch';
  sw.style.cssText='width:24px;height:24px;border-radius:6px;background:'+c+';cursor:pointer;border:2px solid transparent;';
  sw.addEventListener('click',function(e){e.stopPropagation();
    if(!ctxId)return;var n=nod(ctxId);
    if(n.type==='sticky')n.color=c;else if(n.type==='label')n.color=c;
    saveDB();render();setSel(ctxId);cpEl.style.display='none';ctxId=null;
  });
  cpRow.appendChild(sw);
});
function showCpick(id){
  var el=worldEl.querySelector('[data-id="'+id+'"]');
  ctxId=id;cpEl.style.display='block';
  if(el){var r=el.getBoundingClientRect();cpEl.style.left=Math.min(r.left,window.innerWidth-165)+'px';cpEl.style.top=Math.min(r.bottom+4,window.innerHeight-60)+'px';}
  else{cpEl.style.left='50%';cpEl.style.top='50%';}
}
document.addEventListener('click',function(e){if(!cpEl.contains(e.target))cpEl.style.display='none';});

/* ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ */
ge('exp-btn').addEventListener('click',function(){
  var data=JSON.stringify(DB,null,2);
  var blob=new Blob([data],{type:'application/json'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='clipspace-board-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);
  toast('Board exported!');
});
ge('imp-btn').addEventListener('click',function(){ge('imp-file').click();});
ge('imp-file').addEventListener('change',function(){
  var file=this.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var d=JSON.parse(e.target.result);
      if(!d||!d.root||!d.nodes||!d.nodes[d.root]){toast('‚ö† Invalid board file');return;}
      if(!confirm('Import this board? This will replace your current board.'))return;
      DB=d;if(!d.pos)DB.pos={};if(!d.views)DB.views={};
      DB.current=DB.root;saveDB();
      V={tx:0,ty:0,scale:1};
      render();setTimeout(fitAll,60);
      toast('Board imported!');
    }catch(err){toast('‚ö† Could not read file');}
  };
  reader.readAsText(file);
  this.value='';
});

/* ‚îÄ‚îÄ TEMPLATES ‚îÄ‚îÄ */
var TEMPLATES=[
  {section:'Notes',items:[
    {name:'Blank note',desc:'Empty text note',icon:'üìù',bg:'#1c1c22',fn:mkNote},
    {name:'Daily journal',desc:'Date, mood, highlights',icon:'üìì',bg:'#1c1c28',fn:function(){var id=uid(),p=dropPos(210,100);DB.nodes[id]={id:id,type:'note',name:new Date().toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'}),parent:DB.current,text:'Mood: \n\nHighlights:\n\nNotes:\n\nTomorrow:',t:ts()};nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);saveDB();render();setSel(id);openEditor(id);}},
    {name:'Meeting notes',desc:'Agenda, actions, decisions',icon:'üóí',bg:'#1c1c28',fn:function(){var id=uid(),p=dropPos(210,100);DB.nodes[id]={id:id,type:'note',name:'Meeting Notes',parent:DB.current,text:'Date: \nAttendees:\n\nAgenda:\n1. \n\nDecisions:\n\nAction items:\n- ',t:ts()};nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);saveDB();render();setSel(id);openEditor(id);}},
    {name:'Brain dump',desc:'Clear your head',icon:'üß†',bg:'#1c1c28',fn:function(){var id=uid(),p=dropPos(210,100);DB.nodes[id]={id:id,type:'note',name:'Brain Dump',parent:DB.current,text:'Everything on my mind:\n\n',t:ts()};nod(DB.current).kids.push(id);setPos(DB.current,id,p.x,p.y,null,null);saveDB();render();setSel(id);openEditor(id);}},
  ]},
  {section:'Stickies',items:[
    {name:'Yellow',desc:'Classic yellow',icon:'üìå',bg:'#ffd060',fn:function(){mkSticky('Write something here‚Ä¶','#ffd060');}},
    {name:'Green',desc:'Fresh green',icon:'üìå',bg:'#a8f0c6',fn:function(){mkSticky('Write something here‚Ä¶','#a8f0c6');}},
    {name:'Pink',desc:'Soft pink',icon:'üìå',bg:'#ffa8d5',fn:function(){mkSticky('Write something here‚Ä¶','#ffa8d5');}},
    {name:'Blue',desc:'Cool blue',icon:'üìå',bg:'#a8ccff',fn:function(){mkSticky('Write something here‚Ä¶','#a8ccff');}},
  ]},
  {section:'Shapes',items:[
    {name:'Rectangle',desc:'Solid or outline',icon:'‚ñ≠',bg:'#1c1c28',fn:function(){mkShape('rect','none','#4f8fff',2.5,120);}},
    {name:'Circle',desc:'Round shape',icon:'‚óØ',bg:'#1c1c28',fn:function(){mkShape('circle','none','#32d17a',2.5,120);}},
    {name:'Triangle',desc:'Three-sided',icon:'‚ñ≥',bg:'#1c1c28',fn:function(){mkShape('triangle','none','#ffd060',2.5,120);}},
    {name:'Diamond',desc:'Four-sided diamond',icon:'‚óá',bg:'#1c1c28',fn:function(){mkShape('diamond','none','#9b6fff',2.5,120);}},
    {name:'Star',desc:'Five-point star',icon:'‚òÜ',bg:'#1c1c28',fn:function(){mkShape('star','none','#ff6eb4',2.5,120);}},
    {name:'Arrow ‚Üí',desc:'Right arrow',icon:'‚Üí',bg:'#1c1c28',fn:function(){mkShape('arrow-r','none','#4f8fff',2.5,120);}},
    {name:'Arrow ‚Üê',desc:'Left arrow',icon:'‚Üê',bg:'#1c1c28',fn:function(){mkShape('arrow-l','none','#4f8fff',2.5,120);}},
    {name:'Line ‚Äî',desc:'Horizontal line',icon:'‚Äî',bg:'#1c1c28',fn:function(){mkShape('line-h','none','#6e6e82',2.5,120);}},
    {name:'Line |',desc:'Vertical line',icon:'|',bg:'#1c1c28',fn:function(){mkShape('line-v','none','#6e6e82',2.5,120);}},
    {name:'Diagonal ‚Üò',desc:'Down-right line',icon:'‚Üò',bg:'#1c1c28',fn:function(){mkShape('line-d','none','#6e6e82',2.5,120);}},
    {name:'Diagonal ‚Üô',desc:'Down-left line',icon:'‚Üô',bg:'#1c1c28',fn:function(){mkShape('line-dl','none','#6e6e82',2.5,120);}},
    {name:'Bracket [ ]',desc:'Open bracket',icon:'[]',bg:'#1c1c28',fn:function(){mkShape('bracket','none','#e8e8ee',2.5,160);}},
  ]},
  {section:'Labels',items:[
    {name:'Big heading',desc:'Large bold title',icon:'Aa',bg:'#1c1c22',fn:function(){mkLabel('Heading',42,'#e8e8ee');}},
    {name:'Blue label',desc:'Coloured heading',icon:'Aa',bg:'#1c2040',fn:function(){mkLabel('Label',24,'#4f8fff');}},
    {name:'Small tag',desc:'Tiny annotation',icon:'Aa',bg:'#1c1c22',fn:function(){mkLabel('tag',13,'#6e6e82');}},
  ]},
  {section:'Checklists',items:[
    {name:'To-do list',desc:'Simple tasks',icon:'‚òë',bg:'#1c1c22',fn:function(){mkChecklist('To-do',[{t:'First task',done:false},{t:'Second task',done:false},{t:'Third task',done:false}]);}},
    {name:'Sprint tasks',desc:'Dev checklist',icon:'üöÄ',bg:'#1c1c22',fn:function(){mkChecklist('Sprint',[{t:'Plan',done:false},{t:'Build',done:false},{t:'Test',done:false},{t:'Review',done:false},{t:'Deploy',done:false}]);}},
    {name:'Shopping',desc:'Grocery list',icon:'üõí',bg:'#1c1c22',fn:function(){mkChecklist('Shopping',[{t:'Item 1',done:false},{t:'Item 2',done:false},{t:'Item 3',done:false}]);}},
  ]},
  {section:'Links',items:[
    {name:'Link card',desc:'Save any URL',icon:'üîó',bg:'#1c1c22',fn:function(){var url=prompt('URL:','https://');if(!url||url==='https://')return;var title=prompt('Title:','')||url;mkLink(title,url,'');}},
  ]},
  {section:'Folders',items:[
    {name:'Project folder',desc:'Organise a project',icon:'üìÅ',bg:'#15151c',fn:mkFolder},
  ]},
];

function buildTPL(){
  var list=ge('tpl-list');list.innerHTML='';
  TEMPLATES.forEach(function(section){
    var lbl=document.createElement('div');lbl.className='tpl-sec';lbl.textContent=section.section;list.appendChild(lbl);
    section.items.forEach(function(tpl){
      var row=document.createElement('div');row.className='tpl-item';
      row.innerHTML='<div class="tpl-ico" style="background:'+tpl.bg+';font-family:var(--font);font-size:13px;font-weight:700;">'+esc(tpl.icon)+'</div>'
        +'<div><div class="tpl-name">'+esc(tpl.name)+'</div><div class="tpl-desc">'+esc(tpl.desc)+'</div></div>';
      row.addEventListener('click',function(){tpl.fn();if(window.innerWidth<700){ge('tpl-panel').classList.remove('open');ge('tb-tpl').classList.remove('active');}});
      list.appendChild(row);
    });
  });
}

/* ‚îÄ‚îÄ PAN ‚îÄ‚îÄ */
var panning=false,spaceDown=false,panStart={};
stageEl.addEventListener('pointerdown',function(e){
  if(e.button===1||(e.button===0&&spaceDown)){
    e.preventDefault();panning=true;stageEl.style.cursor='grabbing';
    stageEl.setPointerCapture(e.pointerId);panStart={x:e.clientX,y:e.clientY,tx:V.tx,ty:V.ty};
  }
});
stageEl.addEventListener('pointermove',function(e){if(!panning)return;V.tx=panStart.tx+(e.clientX-panStart.x);V.ty=panStart.ty+(e.clientY-panStart.y);applyView();});
stageEl.addEventListener('pointerup',function(e){if(!panning)return;panning=false;stageEl.style.cursor='';stageEl.releasePointerCapture(e.pointerId);saveView();});
stageEl.addEventListener('dblclick',function(e){
  if(e.target!==stageEl&&e.target!==worldEl&&e.target!==gridCvs)return;
  if(ge('ed-bg').classList.contains('open'))return;mkNote();
});
stageEl.addEventListener('click',function(e){if(e.target===stageEl||e.target===worldEl||e.target===gridCvs)clearSel();});

/* ‚îÄ‚îÄ WHEEL ZOOM ‚îÄ‚îÄ */
var _wX=window.innerWidth/2,_wY=window.innerHeight/2,_wD=0,_wRaf=null;
stageEl.addEventListener('wheel',function(e){
  e.preventDefault();_wX=e.clientX;_wY=e.clientY;_wD+=e.deltaY*(e.ctrlKey?3:1);
  if(!_wRaf)_wRaf=requestAnimationFrame(function(){zoomAt(_wX,_wY,Math.pow(0.999,_wD));_wD=0;_wRaf=null;});
},{passive:false});

/* ‚îÄ‚îÄ PINCH ‚îÄ‚îÄ */
var pD=null,pM=null;
stageEl.addEventListener('touchstart',function(e){if(e.touches.length===2){pD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);pM={x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2};}},{passive:true});
stageEl.addEventListener('touchmove',function(e){
  if(e.touches.length!==2)return;e.preventDefault();
  var d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  var mx=(e.touches[0].clientX+e.touches[1].clientX)/2,my=(e.touches[0].clientY+e.touches[1].clientY)/2;
  if(pD)zoomAt(mx,my,d/pD);if(pM){V.tx+=mx-pM.x;V.ty+=my-pM.y;applyView();}pD=d;pM={x:mx,y:my};
},{passive:false});
stageEl.addEventListener('touchend',function(){pD=null;pM=null;},{passive:true});

/* ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ */
window.addEventListener('keydown',function(e){
  if(e.code==='Space'&&!e.target.matches('input,textarea,select')){e.preventDefault();spaceDown=true;stageEl.style.cursor='grab';}
  if(e.key==='Escape'){hideCtx();closeModals();if(ge('ed-bg').classList.contains('open')){flushEd();closeEditor(true);}clearSel();ge('tpl-panel').classList.remove('open');ge('tb-tpl').classList.remove('active');}
  if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();flushEd();toast('Saved ‚úì');}
  if((e.ctrlKey||e.metaKey)&&(e.key==='='||e.key==='+')){e.preventDefault();zoomAt(window.innerWidth/2,window.innerHeight/2,1.25);}
  if((e.ctrlKey||e.metaKey)&&e.key==='-'){e.preventDefault();zoomAt(window.innerWidth/2,window.innerHeight/2,1/1.25);}
  if((e.ctrlKey||e.metaKey)&&e.key==='0'){e.preventDefault();fitAll();}
  if((e.key==='Delete'||e.key==='Backspace')&&sel&&!e.target.matches('input,textarea,select')&&!ge('ed-bg').classList.contains('open')){e.preventDefault();delNode(sel);}
});
window.addEventListener('keyup',function(e){if(e.code==='Space'){spaceDown=false;stageEl.style.cursor='';}});

function closeModals(){['rn-bg','lbl-bg','sty-bg','shp-bg'].forEach(function(id){ge(id).classList.remove('open');});}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
ge('tb-note').addEventListener('click',mkNote);
ge('tb-folder').addEventListener('click',mkFolder);
ge('tb-label').addEventListener('click',function(){ge('lbl-bg').classList.add('open');setTimeout(function(){ge('lbl-inp').focus();},100);});
ge('tb-sticky').addEventListener('click',function(){ge('sty-bg').classList.add('open');setTimeout(function(){ge('sty-inp').focus();},100);});
ge('tb-zi').addEventListener('click',function(){zoomAt(window.innerWidth/2,window.innerHeight/2,1.3);});
ge('tb-zo').addEventListener('click',function(){zoomAt(window.innerWidth/2,window.innerHeight/2,1/1.3);});
ge('tb-fit').addEventListener('click',fitAll);
ge('tb-del').addEventListener('click',function(){if(sel)delNode(sel);else toast('Select a card first');});
ge('zoom-lbl').addEventListener('click',function(){V.scale=1;fitAll();toast('Zoom reset');});

window.addEventListener('resize',drawGrid);

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
var _tt;
function toast(msg){var el=ge('toast');el.textContent=msg;el.classList.add('show');clearTimeout(_tt);_tt=setTimeout(function(){el.classList.remove('show');},2200);}

/* ‚îÄ‚îÄ ADD SHAPES BUTTON TO TOOLBAR ‚îÄ‚îÄ */
(function(){
  var sep=document.createElement('div');sep.className='tb-sep';
  var btn=document.createElement('button');btn.className='tb';btn.textContent='‚¨° Shapes';
  btn.addEventListener('click',openShapeModal);
  var toolbar=ge('toolbar');
  // insert after sticky button
  var stickyBtn=ge('tb-sticky');
  stickyBtn.parentNode.insertBefore(sep,stickyBtn.nextSibling);
  stickyBtn.parentNode.insertBefore(btn,sep.nextSibling);
})();

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
function init(){
  if(!DB.nodes[DB.root]){DB.nodes[DB.root]={id:DB.root,type:'folder',name:'My Board',parent:null,kids:[],t:ts()};DB.pos[DB.root]={};saveDB();}
  DB.current=DB.root;
  if(!(nod(DB.root).kids||[]).length){
    var n1=uid();DB.nodes[n1]={id:n1,type:'note',name:'Welcome to Clipspace ‚ú¶',parent:DB.root,text:'Your infinite canvas.\n\n‚Üí Scroll / pinch to zoom\n‚Üí Space + drag to pan\n‚Üí Double-click empty space = new note\n‚Üí Drag any card anywhere\n‚Üí Grab corner handle to resize\n‚Üí Right-click for options\n‚Üí Click folder to go inside, use Back ‚Üê to return\n‚Üí ‚äû Templates for quick starts\n‚Üí Export/Import to save your board',t:ts()};
    nod(DB.root).kids.push(n1);setPos(DB.root,n1,-240,-100,null,null);

    var s1=uid();DB.nodes[s1]={id:s1,type:'sticky',name:'sticky',text:'Drag me anywhere!',color:'#ffd060',parent:DB.root,t:ts()};
    nod(DB.root).kids.push(s1);setPos(DB.root,s1,40,-80,null,null);

    var l1=uid();DB.nodes[l1]={id:l1,type:'label',name:'My Board',parent:DB.root,size:44,color:'#4f8fff',t:ts()};
    nod(DB.root).kids.push(l1);setPos(DB.root,l1,-240,-210,null,null);

    var f1=uid();DB.nodes[f1]={id:f1,type:'folder',name:'Ideas',parent:DB.root,kids:[],t:ts()};DB.pos[f1]={};
    nod(DB.root).kids.push(f1);setPos(DB.root,f1,40,-200,null,null);

    var sh1=uid();DB.nodes[sh1]={id:sh1,type:'shape',shape:'circle',fill:'none',stroke:'#32d17a',sw:2.5,sz:100,name:'circle',parent:DB.root,t:ts()};
    nod(DB.root).kids.push(sh1);setPos(DB.root,sh1,240,-100,100,100);

    var c1=uid();DB.nodes[c1]={id:c1,type:'checklist',name:'Getting Started',items:[{t:'Create a note',done:false},{t:'Try shapes ‚Üí',done:false},{t:'Open a folder',done:false},{t:'Export board',done:false}],parent:DB.root,t:ts()};
    nod(DB.root).kids.push(c1);setPos(DB.root,c1,260,-220,null,null);
    saveDB();
  }
  buildTPL();
  restoreView(DB.root);
  if(!DB.views[DB.root])setTimeout(fitAll,60);
  render();
}

init();
})();
</script>
</body>
</html>

